---
title: "First try in fitting a model"
output:
  github_document:
    toc: true
---


## Let's load the libraries

```{r}
library(tidyverse)
library(magrittr)
library(ggplot2)
library(rstan)
library(modelr)
library(rlang)
library(GGally)
library(tidybayes)            # install from github
library(tidybayes.rethinking) # install from github
library(gganimate)            # install from github
library(rethinking)
library(shinystan)


theme_set(theme_light())
options(mc.cores = parallel::detectCores())
rstan_options(auto_write = TRUE)
```

## Let's create and normalize the dataframe

```{r}

d = read.csv('SliderBias-PctStudy.tsv', sep='\t') %>%
  mutate(expected_rating = expected_rating/100, rating = rating/100) %>% 
  filter(expected_rating!=0.0 & expected_rating!=1.0 & rating!=0.0 & rating!=1.0) %>% 
  sample_n(1000)

```

## Convert the data to the format stan needs

```{r}
standata = list(
  rating=d$rating,
  expected_rating=d$expected_rating,
  N=nrow(d)
)
```

## Fit the model

```{r}
fit <- stan(file = 'vas-model.stan', data = standata, 
            iter = 1000, chains = 4)
```

```{r}
y <- as.data.frame(fit) 
```

```{r}
pairs(y)
```
```{r}
show(fit)
```

```{r}
plot(fit)
```

```{r, eval = FALSE}
#launch_shinystan(fit)
```


## Simulate expected_ratings
```{r}

sim_df <-  seq(from=0, to=1, length.out=100) %>% 
    as.data.frame() %>% 
      subset(. != 0 & . != 1 ) %>% 
        plyr::rename(c("."="sim_exp_rating"))

```


## Calculate mu and merge 
```{r}

d_new = merge(y, sim_df, all = TRUE) %>% 
 mutate(mu  = inv_logit(a + b * logit(sim_exp_rating)), pred = rbeta(n(), (mu * v) , (1 - mu) * v))

```

## Try plotting

Aesthetics must be either length 1 or the same as the data (196000): y, x error comes when try to Knit the below code. 

```{r}

d_new %>% 
    ggplot(aes(x= sim_exp_rating))+
    stat_lineribbon(aes(y = pred-sim_exp_rating), .prob = c(.99, .9, .8, .5)) +
    geom_point(aes(y=rating-expected_rating, x = expected_rating), data = d, alpha=0.3) +
      
    scale_fill_brewer() +
      ggtitle("Test Plot")

```




